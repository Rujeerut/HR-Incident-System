<!DOCTYPE html>
<html lang="th">
<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="//script.google.com">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <title>HR Incident Reporting System - BJC Big C</title>
  
  <!-- Tailwind via CDN (works on GitHub Pages) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Fonts: Mitr primary, Prompt fallback -->
 <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    .skeleton {
  position: relative; overflow: hidden; background: #f3f4f6;
}
.skeleton::after {
  content: ""; position: absolute; inset: 0;
  transform: translateX(-100%);
  background: linear-gradient(90deg, transparent, rgba(255,255,255,.6), transparent);
  animation: loading 1.2s infinite;
}
@keyframes loading { to { transform: translateX(100%); } }
    .card-hover {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.card-hover:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 16px rgba(0,0,0,0.08);
}
    
    :root {
      --brand-blue-600:#2563eb; /* tailwind blue-600 */
      --brand-blue-700:#1d4ed8; /* tailwind blue-700 */
      --brand-purple-600:#7c3aed; /* tailwind purple-600 */
      --brand-pink-600:#db2777; /* tailwind pink-600 */
    }
    html, body {
  font-family: 'Prompt', system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
}

    /* Custom step styles */
    .step-indicator { transition: all .25s ease; }
    .step-indicator.active {
      background: linear-gradient(135deg, #3B82F6, #1D4ED8);
      color:#fff;
    }
    .step-indicator.completed {
      background: linear-gradient(135deg, #10B981, #059669);
      color:#fff;
    }

    /* Card hover */
    .card-hover { transition: transform .2s ease, box-shadow .2s ease; }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0,0,0,.1); }

    /* Appear animations */
    .fade-in { animation: fadeIn .5s ease-in; }
    @keyframes fadeIn { from{opacity:0; transform: translateY(20px)} to{opacity:1; transform: translateY(0)} }
    .floating-element { animation: float 6s ease-in-out infinite }
    @keyframes float { 0%,100%{ transform: translateY(0) rotate(0)} 50%{ transform: translateY(-18px) rotate(180deg)} }

    /* Priority accents */
    .priority-critical { border-left: 6px solid #EF4444 }
    .priority-medium { border-left: 6px solid #F59E0B }
    .priority-low { border-left: 6px solid #10B981 }

/* ===== ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡πÄ‡∏Å‡∏•‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏¢‡πà‡∏≠‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 80% ===== */
@media (max-width: 768px) {
  body {
    transform: scale(0.8);           /* ‡∏¢‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 80% */
    transform-origin: top center;    /* ‡∏à‡∏∏‡∏î‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠ (‡∏ö‡∏ô-‡∏Å‡∏•‡∏≤‡∏á) */
    width: 125%;                     /* ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ä‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏á */
  }

  /* ‡∏õ‡∏£‡∏±‡∏ö margin/padding ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô */
  .page-container {
    padding: 1rem;
  }
}
    
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen">
  <!-- Top Navigation -->
  <nav class="bg-white shadow-lg border-b-4 border-blue-600">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center gap-4">
          <img src="https://i.postimg.cc/B6wpk3yh/cropped-Logo-BJC-Big-C-2021-2048x606.png" alt="BJC Big C Logo" class="h-12" />
          <div>
            <h1 class="text-2xl font-bold text-gray-800">HR Incident Reporting</h1>
            <p class="text-sm text-gray-600">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</p>
          </div>
        </div>
        <div class="flex gap-2">
          <button onclick="showPage('report')" class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</button>
          <button onclick="showPage('history')" class="px-5 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">History</button>
          <button onclick="showPage('dashboard')" class="px-5 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-semibold">Dashboard</button>
          <button onclick="showHRBPLogin()" class="px-5 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold">üîê HRBP</button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Report Page -->
  <main id="reportPage" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Stepper -->
    <div class="flex items-center justify-center mb-8">
      <div class="flex items-center gap-4">
        <div id="step1" class="step-indicator active w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg">1</div>
        <div class="w-16 h-1 bg-gray-300"></div>
        <div id="step2" class="step-indicator w-12 h-12 rounded-full bg-gray-300 flex items-center justify-center font-bold text-lg">2</div>
        <div class="w-16 h-1 bg-gray-300"></div>
        <div id="step3" class="step-indicator w-12 h-12 rounded-full bg-gray-300 flex items-center justify-center font-bold text-lg">3</div>
        <div class="w-16 h-1 bg-gray-300"></div>
        <div id="step4" class="step-indicator w-12 h-12 rounded-full bg-gray-300 flex items-center justify-center font-bold text-lg">4</div>
      </div>
    </div>

    <!-- Step 1: Intro -->
    <section id="introStep" class="fade-in relative">
      <!-- Cute floating background shapes -->
      <div class="absolute inset-0 overflow-hidden pointer-events-none">
        <div class="floating-element absolute top-10 left-10 w-12 h-12 bg-blue-200 rounded-full opacity-20"></div>
        <div class="floating-element absolute top-20 right-20 w-10 h-10 bg-purple-200 rounded-full opacity-30" style="animation-delay:1s"></div>
        <div class="floating-element absolute bottom-20 left-20 w-8 h-8 bg-pink-200 rounded-full opacity-25" style="animation-delay:2s"></div>
        <div class="floating-element absolute bottom-10 right-10 w-14 h-14 bg-indigo-200 rounded-full opacity-20" style="animation-delay:.5s"></div>
      </div>

      <div class="relative max-w-4xl mx-auto text-center">
        <div class="relative mb-6">
          <div class="w-20 h-20 bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-xl animate-pulse">
            <div class="w-14 h-14 bg-white rounded-full flex items-center justify-center shadow-inner">
              <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
            </div>
          </div>
        </div>

        <h1 class="text-4xl font-extrabold leading-tight mb-3">
          <span class="bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 bg-clip-text text-transparent">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</span><br />
          <span class="bg-gradient-to-r from-indigo-600 via-blue-600 to-cyan-600 bg-clip-text text-transparent">‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•</span>
        </h1>
        <p class="text-lg text-gray-600">HR Incident Reporting System</p>
        <p class="text-sm text-gray-500 mb-6">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢ ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢</p>

        <button onclick="nextStep()" class="group relative bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 hover:from-blue-700 hover:via-purple-700 hover:to-pink-700 text-white font-bold py-4 px-8 rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-300 text-lg transform hover:scale-105 hover:-translate-y-1 w-full sm:w-auto">
          <span class="relative z-10 inline-flex items-center">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå
            <svg class="w-6 h-6 ml-3 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/></svg>
          </span>
          <span class="absolute inset-0 bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 rounded-2xl blur-xl opacity-30 group-hover:opacity-50"></span>
        </button>
      </div>
    </section>

   <!-- Step 2: Category selection (dynamic) -->
    <section id="categoryStep" class="hidden fade-in">
      <div class="text-center mb-4">
        <h2 class="text-2xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á</h2>
        <p class="text-sm text-gray-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á</p>
      </div>

      <!-- Dynamic grid here -->
      <div id="categoryGrid" class="grid grid-cols-2 lg:grid-cols-4 gap-3 max-w-4xl mx-auto"></div>

      <!-- Error -->
      <div id="categoryError" class="hidden text-center text-red-600 text-sm mt-4"></div>
    </section>

    <!-- Step 3: Sub-category -->
    <section id="subCategoryStep" class="hidden fade-in">
      <div class="text-center mb-6">
        <button onclick="goBackToCategory()" class="mb-4 px-4 py-2 border-2 border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 text-sm">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏•‡∏±‡∏Å</button>
        <h2 id="subCategoryTitle" class="text-xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢</h2>
        <p class="text-sm text-gray-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</p>
      </div>
      <div id="subCategoryCards" class="grid grid-cols-2 gap-4 max-w-3xl mx-auto"></div>
    </section>

    <!-- Step 4: Details form -->
    <section id="detailsStep" class="hidden fade-in">
      <div class="max-w-4xl mx-auto bg-gradient-to-br from-white to-gray-50 rounded-2xl shadow-xl p-4 md:p-6 border border-gray-100">
        <div class="flex items-center mb-4">
          <div id="priorityIcon" class="w-8 h-8 rounded-xl mr-3 shadow-md"></div>
          <div>
            <h2 id="formTitle" class="text-lg font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á</h2>
            <p id="formSubtitle" class="text-xs text-gray-600 mt-1">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</p>
          </div>
        </div>
        <form onsubmit="submitReport(event)">
          <!-- Date / Time -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
            <div class="bg-blue-50 rounded-lg p-3 border border-blue-200">
              <div class="flex items-center justify-between mb-2">
                <label class="block text-blue-800 font-semibold text-xs">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á</label>
                <button type="button" id="editDateBtn" onclick="toggleDateEdit()" class="text-xs text-blue-600 hover:text-blue-800 underline">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              </div>
              <input type="date" id="reportDate" readonly class="w-full px-3 py-2 bg-white border border-blue-300 rounded-lg text-gray-700 cursor-not-allowed text-sm" />
            </div>
            <div class="bg-blue-50 rounded-lg p-3 border border-blue-200">
              <div class="flex items-center justify-between mb-2">
                <label class="block text-blue-800 font-semibold text-xs">üïê ‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏à‡πâ‡∏á</label>
                <button type="button" id="editTimeBtn" onclick="toggleTimeEdit()" class="text-xs text-blue-600 hover:text-blue-800 underline">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              </div>
              <input type="time" id="reportTime" readonly class="w-full px-3 py-2 bg-white border border-blue-300 rounded-lg text-gray-700 cursor-not-allowed text-sm" />
            </div>
          </div>

          <!-- Reporter info (demo autofill) -->
          <div class="bg-gray-50 rounded-lg p-4 mb-4 border border-gray-200">
  <h3 class="text-sm font-bold text-gray-800 mb-3 flex items-center">
    <svg class="w-4 h-4 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
    </svg>
    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á
  </h3>

  <!-- ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1 -->
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
    <div>
      <label class="block text-gray-700 font-semibold mb-1 text-xs">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
      <input type="text" id="employeeName" readonly
        class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 text-sm cursor-not-allowed" />
    </div>
    <div>
      <label class="block text-gray-700 font-semibold mb-1 text-xs">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
      <input type="text" id="employeeCode" readonly
        class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 text-sm cursor-not-allowed" />
    </div>
  </div>

  <!-- ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 2 -->
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
    <div>
      <label class="block text-gray-700 font-semibold mb-1 text-xs">Company</label>
      <input type="text" id="employeeCompany" readonly
        class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 text-sm cursor-not-allowed" />
    </div>
    <div>
      <label class="block text-gray-700 font-semibold mb-1 text-xs">Division</label>
      <input type="text" id="employeeDivision" readonly
        class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 text-sm cursor-not-allowed" />
    </div>
  </div>

  <!-- ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 3 -->
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
    <div>
      <label class="block text-gray-700 font-semibold mb-1 text-xs">Department</label>
      <input type="text" id="employeeDepartment" readonly
        class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 text-sm cursor-not-allowed" />
    </div>
    <div>
      <label class="block text-gray-700 font-semibold mb-1 text-xs">Store</label>
      <input type="text" id="employeeStore" readonly
        class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 text-sm cursor-not-allowed" />
    </div>
  </div>

  <!-- ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 4 -->
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
    <div>
      <label class="block text-gray-700 font-semibold mb-1 text-xs">Email</label>
      <input type="email" id="employeeEmail" readonly
        class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 text-sm cursor-not-allowed" />
    </div>
    <div>
      <label class="block text-gray-700 font-semibold mb-1 text-xs">Contact number</label>
      <input type="tel" id="employeePhone" readonly
        class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 text-sm cursor-not-allowed" />
    </div>
  </div>
</div>
              
         <!-- HR Business Partner ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤/‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á) -->
<div class="bg-gray-50 rounded-lg p-4 mb-6 border border-gray-200">  <!-- mb-6 => ‡πÄ‡∏ß‡πâ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏Å‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ -->
  <h4 class="text-gray-800 font-semibold mb-3 text-sm flex items-center gap-2">
    HR Business Partner ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
  </h4>

  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
    <div>
      <label class="block text-gray-700 font-semibold mb-1 text-xs">HRBP Name</label>
      <input type="text" id="assignedHRBP" readonly
             class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 text-sm cursor-not-allowed" />
    </div>
    <div>
      <label class="block text-gray-700 font-semibold mb-1 text-xs">HRBP Email</label>
      <input type="text" id="assignedHRBPEmail" readonly
             class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 text-sm cursor-not-allowed" />
    </div>
  </div>
</div>

          <!-- Incident details -->
          <div class="bg-yellow-50 rounded-lg p-4 mt-4 mb-4 border border-yellow-200">
  <h3 class="text-sm font-bold text-gray-800 mb-3 flex items-center">
    <svg class="w-4 h-4 mr-2 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
    </svg>
    ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå
  </h3>

  <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î -->
  <div class="mb-3">
    <label class="block text-gray-700 font-semibold mb-1 text-xs">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå *</label>
    <textarea id="incidentDetail" required rows="4"
      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
      placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏, ‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á, ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏"></textarea>
  </div>

  <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏: ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏î‡πâ + ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï -->
  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
    <div class="relative">
      <label class="block text-gray-700 font-semibold mb-1 text-xs">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏</label>
      <input type="text" id="locationInput"
        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
        placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà..." autocomplete="off" oninput="typeaheadLocation(this.value)" />
      <div id="locationDropdown"
        class="hidden absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-40 overflow-y-auto"></div>
    </div>

    <!-- ‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) -->
    <div>
      <label class="block text-gray-700 font-semibold mb-1 text-xs">‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á</label>
      <input type="text"
        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
        placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" />
    </div>
  </div>

  <!-- ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û -->
  <div class="mt-4">
    <label class="block text-gray-700 font-semibold mb-1 text-xs">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
    <input type="file" id="incidentPhotos" accept="image/*" multiple
      class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-600 file:text-white hover:file:bg-blue-700" />
    <!-- Preview -->
    <div id="photoPreview" class="mt-3 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2"></div>
    <p class="text-xs text-gray-500 mt-1">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå .jpg, .png, .heic ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB ‡∏ï‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏£‡∏π‡∏õ)</p>
  </div>
</div>

          <div class="flex gap-3">
            <button type="button" onclick="goBack()" class="px-4 py-3 border-2 border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 text-sm"> ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
            <button type="submit" id="submitBtn"
 class="flex-1 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800
         text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl text-sm">
  ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå
</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Step 5: Success -->
    <section id="successStep" class="hidden fade-in max-w-md mx-auto">
  <div class="bg-white rounded-3xl shadow-xl p-8 text-center">
    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-5">
      <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
      </svg>
    </div>

    <h2 class="text-2xl font-extrabold text-gray-900 mb-2">‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h2>
    <p class="text-gray-600 mb-6 leading-relaxed">
      ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß<br/>HRBP ‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
    </p>

    <div class="bg-blue-50 rounded-xl px-5 py-4 mb-6 border border-blue-100">
      <p class="text-blue-800 text-sm">
        ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: <span class="font-extrabold" id="referenceNumber">HR-2025-xxx</span>
      </p>
    </div>

    <button onclick="resetForm()"
      class="w-full bg-blue-600 hover:bg-blue-700 text-white font-extrabold py-3 rounded-xl shadow-lg">
      ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà
    </button>
  </div>
</section>

  <!-- History Page -->
  <section id="historyPage" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent mb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</h1>
      <p class="text-gray-600">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
    </div>

    <!-- Login -->
    <div id="historyLoginSection" class="bg-white rounded-2xl shadow-xl p-8 mb-8">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </div>
        <h3 class="text-2xl font-bold text-gray-800 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h3>
        <p class="text-gray-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå</p>
      </div>
      <form onsubmit="verifyHistoryAccess(event)" class="max-w-md mx-auto">
        <div class="mb-6">
          <label class="block text-gray-700 font-semibold mb-2 flex items-center justify-center">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
          <input type="text" id="historyEmployeeId" required class="w-full px-4 py-3 border-2 border-green-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 text-lg text-center" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô 4 ‡∏´‡∏•‡∏±‡∏Å" />
        </div>
        <button type="submit" class="w-full px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold rounded-xl shadow-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
      </form>
    </div>

    <!-- History content -->
    <div id="historyContent" class="hidden">
      <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
        <div class="max-w-md mx-auto">
          <label class="block text-gray-700 font-semibold mb-3 text-center">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏™</label>
          <div class="flex gap-3">
            <input type="text" id="caseSearch" class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 text-lg" placeholder="‡πÄ‡∏ä‡πà‡∏ô HR-2025-001" />
            <button onclick="searchByCase()" class="px-6 py-3 bg-green-600 text-white rounded-xl hover:bg-green-700 font-semibold">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
          </div>
        </div>
      </div>
      <div id="searchResults" class="hidden">
        <h3 class="text-2xl font-bold text-gray-800 mb-4">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h3>
        <div id="resultsContainer" class="space-y-4"></div>
      </div>

      <div class="bg-white rounded-2xl shadow-xl p-8">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold text-gray-800">‡πÄ‡∏Ñ‡∏™‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
          <button onclick="logoutHistory()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
        <div class="space-y-4">
          <div class="bg-gradient-to-r from-red-50 to-red-100 rounded-xl p-6 border-l-4 border-red-500">
            <div class="flex justify-between items-start">
              <div>
                <h4 class="text-lg font-bold text-gray-800 mb-2">HR-2025-001 - ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡πâ‡∏≤‡∏á</h4>
                <p class="text-gray-600 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ‡∏•‡∏≤‡∏≠‡∏≠‡∏Å | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: 19 ‡∏ï.‡∏Ñ. 2025</p>
                <p class="text-sm text-gray-500">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏•‡∏¥‡∏ï‡∏Ç‡∏≠‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</p>
              </div>
              <div class="flex flex-col gap-2">
                <span class="px-3 py-1 bg-yellow-100 text-yellow-800 text-sm rounded-full">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                <button onclick="viewCaseHistory('HR-2025-001')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
                <button onclick="closeCaseByEmployee('HR-2025-001')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™</button>
              </div>
            </div>
          </div>
          <div class="bg-gradient-to-r from-orange-50 to-orange-100 rounded-xl p-6 border-l-4 border-orange-500">
            <div class="flex justify-between items-start">
              <div>
                <h4 class="text-lg font-bold text-gray-800 mb-2">HR-2025-002 - ‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏</h4>
                <p class="text-gray-600 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: 18 ‡∏ï.‡∏Ñ. 2025</p>
                <p class="text-sm text-gray-500">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏•‡∏¥‡∏ï</p>
              </div>
              <div class="flex flex-col gap-2">
                <span class="px-3 py-1 bg-green-100 text-green-800 text-sm rounded-full">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span>
                <button onclick="viewCaseHistory('HR-2025-002')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Dashboard Page (static demo) -->
  <section id="dashboardPage" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="text-center mb-10">
      <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-xl">
        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
      </div>
      <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-2">Dashboard</h1>
      <p class="text-gray-600">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-10">
      <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl shadow-xl p-8 border border-blue-200 text-center">
        <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        </div>
        <p class="text-4xl font-black text-gray-800 mb-2">24</p>
        <p class="text-blue-700 font-semibold">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
        <p class="text-blue-600 text-sm">Total Reports</p>
      </div>
      <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-2xl shadow-xl p-8 border border-red-200 text-center">
        <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-red-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M5.062 19h13.876"/></svg>
        </div>
        <p class="text-4xl font-black text-gray-800 mb-2">8</p>
        <p class="text-red-700 font-semibold">‡∏î‡πà‡∏ß‡∏ô‡∏°‡∏≤‡∏Å</p>
        <p class="text-red-600 text-sm">Critical Priority</p>
      </div>
      <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-2xl shadow-xl p-8 border border-orange-200 text-center">
        <div class="w-16 h-16 bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
        </div>
        <p class="text-4xl font-black text-gray-800 mb-2">5</p>
        <p class="text-orange-700 font-semibold">‡∏î‡πà‡∏ß‡∏ô</p>
        <p class="text-orange-600 text-sm">High Priority</p>
      </div>
      <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-2xl shadow-xl p-8 border border-green-200 text-center">
        <div class="w-16 h-16 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </div>
        <p class="text-4xl font-black text-gray-800 mb-2">11</p>
        <p class="text-green-700 font-semibold">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</p>
        <p class="text-green-600 text-sm">Medium Priority</p>
      </div>
    </div>

    <!-- Factory tiles (static demo) -->
    <div class="bg-white rounded-3xl shadow-2xl p-10 border border-gray-100">
      <div class="text-center mb-8">
        <h3 class="text-2xl font-bold text-gray-800">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô/‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</h3>
        <p class="text-gray-600">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô (‡πÄ‡∏î‡πÇ‡∏°)</p>
      </div>
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
        <button onclick="viewFactoryDetails('ladkrabang')" class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 border border-blue-200 hover:shadow-lg">‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á ‚Ä¢ 9</button>
        <button onclick="viewFactoryDetails('bangna')" class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4 border border-green-200 hover:shadow-lg">‡∏ö‡∏≤‡∏á‡∏ô‡∏≤ ‚Ä¢ 6</button>
        <button onclick="viewFactoryDetails('samutprakarn')" class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4 border border-purple-200 hover:shadow-lg">‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£ ‚Ä¢ 4</button>
        <button onclick="viewFactoryDetails('chonburi')" class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-4 border border-orange-200 hover:shadow-lg">‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ ‚Ä¢ 3</button>
        <button onclick="viewFactoryDetails('headquarters')" class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-4 border border-gray-200 hover:shadow-lg">‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà ‚Ä¢ 2</button>
      </div>
    </div>
  </section>

  <!-- Employee Login Modal -->
  <div id="employeeModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
        </div>
        <h3 class="text-xl font-bold text-gray-800 mb-1">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á</h3>
        <p class="text-gray-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</p>
      </div>
      <form onsubmit="verifyEmployee(event)">
        <div class="mb-6">
          <label class="block text-gray-700 font-semibold mb-2">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
          <input type="text" id="employeeId" required class="w-full px-4 py-3 border-2 border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô 4 ‡∏´‡∏•‡∏±‡∏Å" />
        </div>
        <div class="flex gap-3">
          <button type="button" onclick="closeEmployeeModal()" class="flex-1 px-6 py-3 border-2 border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-bold rounded-xl shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</button>
        </div>
      </form>
    </div>
  </div>

  <!-- HRBP Login Modal -->
  <div id="hrbpModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
        </div>
        <h3 class="text-xl font-bold text-gray-800 mb-1">HRBP Monitor</h3>
        <p class="text-gray-600">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏™‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö HRBP</p>
      </div>
      <form onsubmit="verifyHRBP(event)">
        <div class="mb-6">
          <label class="block text-gray-700 font-semibold mb-2">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô HRBP</label>
          <input type="text" id="hrbpId" required class="w-full px-4 py-3 border-2 border-purple-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-lg text-center" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô HRBP" />
        </div>
        <div class="flex gap-3">
          <button type="button" onclick="closeHRBPModal()" class="flex-1 px-6 py-3 border-2 border-gray-300 text-gray-700 font-semibold rounded-xl hover:bg-gray-50">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-bold rounded-xl shadow-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Case Detail Modal (demo) -->
  <div id="caseModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-bold text-gray-800" id="caseTitle">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏Ñ‡∏™</h3>
        <button onclick="closeCaseModal()" class="text-gray-500 hover:text-gray-700" aria-label="‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div id="caseContent" class="space-y-4 mb-8"></div>
      <div class="flex gap-3">
        <button onclick="closeCaseModal()" class="flex-1 px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

  <script>
     // ===== API CONFIG & HELPERS =====
    // üîó ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô Web App URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏Ç‡∏≠‡∏á Apps Script ‡∏ó‡∏µ‡πà‡∏°‡∏µ action=categories)
    const API_URL = 'https://script.google.com/macros/s/AKfycbz1whkbxKCJfjz1z0MxqFqeolY5nxvig0SV62QAi2Jz-CNjJRh9c0_ubxPIwzImu804Yw/exec';

    async function apiGet(params) {
      const url = API_URL + '?' + new URLSearchParams(params).toString();
      const res = await fetch(url, { method:'GET' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }
    async function apiPost(payload) {
  // 1) ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö JSON (text/plain) ‡∏Å‡πà‡∏≠‡∏ô ‚Äì ‡πÑ‡∏°‡πà‡∏°‡∏µ header ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á preflight
  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), 30000); // 30s timeout (‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà)
  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify(payload),
      signal: controller.signal,
      cache: 'no-cache',
      // no headers -> simple request
      // mode: 'cors' (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
    });
    clearTimeout(t);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  } catch (err) {
    clearTimeout(t);
    // 2) Fallback: ‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô multipart/form-data (‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á CORS ‡πÄ‡∏ä‡πà‡∏ô‡∏Å‡∏±‡∏ô)
    //    ‡πÅ‡∏ô‡∏ö JSON ‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ä‡∏∑‡πà‡∏≠ "payload"
    const fd = new FormData();
    fd.append('payload', JSON.stringify(payload));

    // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏° (base64) ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô payload ‡πÄ‡∏•‡∏¢
    const res2 = await fetch(API_URL, {
      method: 'POST',
      body: fd,
      cache: 'no-cache'
    });
    if (!res2.ok) throw new Error(`HTTP ${res2.status}`);
    // ‡∏ù‡∏±‡πà‡∏á Apps Script ‡∏à‡∏∞ parse e.parameter.payload ‡πÉ‡∏´‡πâ
    return await res2.json();
  }
}
    // ===== Global state =====
    let currentStep = 1;
    let selectedCategory = '';
    let selectedCategoryTH = '';
    let selectedCategoryEN = '';
    let selectedSubCategory = '';
    let currentPage = 'report';
    let isHRBPLoggedIn = false;
    let isHistoryLoggedIn = false;

    let selectedSubCategoryName = '';
    let selectedDetailName = '';

    // ===== Page router =====
    function showPage(page) {
      currentPage = page;
      document.getElementById('reportPage').classList.add('hidden');
      document.getElementById('historyPage').classList.add('hidden');
      document.getElementById('dashboardPage').classList.add('hidden');
      if (page === 'report')      document.getElementById('reportPage').classList.remove('hidden');
      else if (page === 'history')document.getElementById('historyPage').classList.remove('hidden');
      else if (page === 'dashboard') document.getElementById('dashboardPage').classList.remove('hidden');
    }

    // === CACHE CONFIG ===
  const CATEGORY_CACHE_KEY = 'hrir_categories_v1';
  const CATEGORY_TTL_MS = 5 * 60 * 1000; // 5 ‡∏ô‡∏≤‡∏ó‡∏µ
  let categoryMemCache = null;

  function getCachedCategories() {
    if (categoryMemCache) return categoryMemCache;
    try {
      const raw = localStorage.getItem(CATEGORY_CACHE_KEY);
      if (!raw) return null;
      const { ts, rows } = JSON.parse(raw);
      if (!ts || !rows) return null;
      if (Date.now() - ts > CATEGORY_TTL_MS) return null;
      categoryMemCache = rows;
      return rows;
    } catch { return null; }
  }
  function setCachedCategories(rows) {
    categoryMemCache = rows;
    try { localStorage.setItem(CATEGORY_CACHE_KEY, JSON.stringify({ ts: Date.now(), rows })); } catch {}
  }

  function renderCategorySkeleton() {
    const grid = document.getElementById('categoryGrid');
    grid.innerHTML = '';
    const frag = document.createDocumentFragment();
    for (let i = 0; i < 8; i++) {
      const s = document.createElement('div');
      s.className = 'rounded-xl shadow-lg px-6 py-6 border border-gray-100 skeleton';
      s.style.height = '92px';
      frag.appendChild(s);
    }
    grid.appendChild(frag);
  }

  function renderCategories(rows) {
    const grid = document.getElementById('categoryGrid');
    grid.innerHTML = '';
    const palette = ['blue','orange','yellow','purple','pink','green','indigo'];
    const frag = document.createDocumentFragment();
    rows.forEach((cat, i) => {
      const tone = palette[i % palette.length];
      const btn = document.createElement('button');
      btn.className = `card-hover bg-gradient-to-br from-white to-${tone}-50
  rounded-xl shadow-lg px-6 py-6 border border-${tone}-100
  hover:border-${tone}-300 hover:shadow-xl text-left
  transition-all duration-200 h-[130px] flex flex-col justify-center`;
      btn.innerHTML = `
        <div class="text-center">
          <h3 class="text-base font-bold text-gray-800 mb-1">${escapeHTML_(cat.th)}</h3>
          <p class="text-xs text-gray-600">${escapeHTML_(cat.en || '')}</p>
        </div>`;
      btn.onclick = () => selectCategory(cat);
      frag.appendChild(btn);
    });
    grid.appendChild(frag);
  }
    
    // ===== Dynamic Categories from Case_Master M/N =====
    async function loadCategories(opts = {}){
  const silent = !!opts.silent;
  const grid = document.getElementById('categoryGrid');
  const errorBox = document.getElementById('categoryError');

  if(!silent){
    // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° loader ‡πÅ‡∏•‡πâ‡∏ß: ‡∏ã‡πà‡∏≠‡∏ô error ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    errorBox.classList.add('hidden');
    // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡∏°‡∏µ skeleton ‡∏ï‡∏≠‡∏ô‡πÑ‡∏°‡πà silent ‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ:
    renderCategorySkeleton();
  }

  const cached = getCachedCategories();
  if (cached && cached.length) {
    renderCategories(cached);
    // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° loader ‡πÅ‡∏•‡πâ‡∏ß
    if (silent) {
      // silent mode ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°
    }
  }

  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 5000);

  try{
    const url = API_URL + '?' + new URLSearchParams({ action:'categories' }).toString();
    const res = await fetch(url, { method:'GET', signal: controller.signal, cache:'no-cache' });
    clearTimeout(timeoutId);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const rs = await res.json();
    if(!rs.ok) throw new Error(rs.error || '‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

    const rows = rs.rows || [];
    if(!rows.length) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏ô Case_Master (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå M/N)');

    renderCategories(rows);
    setCachedCategories(rows);
  }catch(err){
    clearTimeout(timeoutId);
    if(!silent){
      errorBox.textContent = (err.name==='AbortError') ? '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ä‡πâ‡∏≤ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà' : String(err.message || err);
      errorBox.classList.remove('hidden');
    }
  }
}

    function escapeHTML_(s){
      return String(s || '')
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }
    
    function showLoading(text='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...'){
  const m = document.getElementById('loadingModal');
  const t = document.getElementById('loadingText');
  if(t) t.textContent = text;
  m.classList.remove('hidden');
}
function hideLoading(){
  document.getElementById('loadingModal').classList.add('hidden');
}
  async function loadSubCategories(catTH, opts = {}) {
  const silent = !!opts.silent;
  const container = document.getElementById('subCategoryCards');
  container.innerHTML = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô

  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 5000);

  try{
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å action=subcategories ‡πÇ‡∏î‡∏¢‡∏™‡πà‡∏á cat=‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
    const url = API_URL + '?' + new URLSearchParams({ action:'subcategories', cat:catTH }).toString();
    const res = await fetch(url, { method:'GET', signal: controller.signal, cache:'no-cache' });
    clearTimeout(timeoutId);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const rs = await res.json();
    if(!rs.ok) throw new Error(rs.error || '‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');

    const rows = rs.rows || [];
    renderSubCategoryCards(rows);

    return rows;
  }catch(err){
    clearTimeout(timeoutId);
    // ‡πÅ‡∏™‡∏î‡∏á error ‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏ó‡∏µ‡πà Step 3 ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
    const scTitle = document.getElementById('subCategoryTitle');
    scTitle.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢';
    document.getElementById('subCategoryCards').innerHTML =
      `<div class="text-center text-sm text-red-600"> ${String(err.message || err)} </div>`;
    return [];
  }
}
    
   async function loadDetails(catTH, subTH){
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 5000);
  try{
    const url = API_URL + '?' + new URLSearchParams({
      action:'details',
      cat: catTH,
      sub: subTH
    }).toString();
    const res = await fetch(url, { method:'GET', signal: controller.signal, cache:'no-cache' });
    clearTimeout(timeoutId);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const rs = await res.json();
    if(!rs.ok) throw new Error(rs.error || '‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    return rs.rows || {detail1:[],detail2:[],detail3:[],detail4:[],detail5:[]};
  }catch(err){
    clearTimeout(timeoutId);
    console.error(err);
    return {detail1:[],detail2:[],detail3:[],detail4:[],detail5:[]};
  }
}

function renderDetailCards(groups){
  const container = document.getElementById('subCategoryCards');
  container.innerHTML = '';

  // ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å detail ‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô
  const all = [
    ...groups.detail1,
    ...groups.detail2,
    ...groups.detail3,
    ...groups.detail4,
    ...groups.detail5
  ].filter(Boolean);

  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢ ‚Üí ‡πÑ‡∏õ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
  if (all.length === 0){
    showEmployeeLogin();
    return;
  }

  // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
  document.getElementById('subCategoryTitle').textContent = 
    `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á ‚Äú${selectedSubCategoryName}‚Äù`;

  // ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡∏Ñ‡∏•‡∏∞‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
  const palette = ['blue','orange','yellow','purple','pink','green','indigo'];
  const frag = document.createDocumentFragment();

  all.forEach((name, i) => {
    const tone = palette[i % palette.length];
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = `
      card-hover bg-gradient-to-br from-white to-${tone}-50
      rounded-2xl shadow-xl p-6 border border-${tone}-100
      hover:border-${tone}-300 hover:shadow-2xl
      h-[130px] w-full flex items-center justify-center text-center
      transition
    `;
    btn.innerHTML = `<div><h4 class="text-base font-semibold text-gray-800">${escapeHTML_(name)}</h4></div>`;
    btn.onclick = () => selectDetail(name);
    frag.appendChild(btn);
  });

  container.appendChild(frag);
}

function renderSubCategoryCards(rows){
  const container = document.getElementById('subCategoryCards');
  container.innerHTML = '';

  if (!rows.length) {
    container.innerHTML = `<div class="text-center text-gray-600 text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ</div>`;
    return;
  }

  // ‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å (‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å)
  const palette = ['blue','orange','yellow','purple','pink','green','indigo'];

  const frag = document.createDocumentFragment();
  rows.forEach((r, i) => {
    const tone = palette[i % palette.length];

    const card = document.createElement('button');
    card.type = 'button';
    card.className =
      `card-hover bg-gradient-to-br from-white to-${tone}-50
       rounded-2xl shadow-xl p-6 border border-${tone}-100
       hover:border-${tone}-300 hover:shadow-2xl
       h-[130px] w-full flex items-center justify-center text-center transition`;

    // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¥‡πÇ‡∏°‡∏à‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö
    card.innerHTML = `
      <div>
        <h3 class="text-base font-semibold text-gray-800 mb-1">${escapeHTML_(r.name)}</h3>
      </div>
    `;

    card.onclick = () => selectSubCategory(r.name);
    frag.appendChild(card);
  });

  container.appendChild(frag);
}
   
    // ===== Employee login (for proceeding to details) =====
    function showEmployeeLogin(){ document.getElementById('employeeModal').classList.remove('hidden'); }
    function closeEmployeeModal(){ document.getElementById('employeeModal').classList.add('hidden'); }
    // helper ‡∏Å‡∏±‡∏ô‡∏û‡∏±‡∏á‡∏ñ‡πâ‡∏≤ id ‡πÑ‡∏´‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô DOM
function setVal(id, v){
  const el = document.getElementById(id);
  if (el) el.value = v || '';
  else console.warn('Missing element id:', id);
}

async function verifyEmployee(e){
  e.preventDefault();
  const id = document.getElementById('employeeId').value.trim();
  if(!id) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');

  showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...');
  try {
    const res = await fetch(API_URL + '?action=employee&empId=' + encodeURIComponent(id));
    const rs = await res.json();
    hideLoading();

    if (!rs.ok) {
      alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ' + (rs.error || ''));
      return;
    }

    const emp = rs.data || {};

    // ‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏´‡∏ô‡∏î:
    // ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• - ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
    setVal('employeeName', emp.name);
    setVal('employeeCode', emp.empId);

    // Company - Division
    setVal('employeeCompany',  emp.company);
    setVal('employeeDivision', emp.division);

    // Department - Store
    setVal('employeeDepartment', emp.department);
    setVal('employeeStore',      emp.store);

    // Email - Contact number
    setVal('employeeEmail', emp.email);
    setVal('employeePhone', emp.phone);

    // HRBP
    setVal('assignedHRBP',      emp.hrbp);
    setVal('assignedHRBPEmail', emp.hrbpEmail);

    closeEmployeeModal();
    proceedToDetails();
  } catch(err){
  hideLoading();
  const msg = (err && err.message) ? err.message : String(err);
  alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n' + msg + '\n\n(‡∏ñ‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô AbortError ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà/‡πÄ‡∏ô‡πá‡∏ï‡∏ä‡πâ‡∏≤)');
}
  }

    // ===== Category & Sub-category =====
       async function selectCategory(cat){
  // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏à‡∏≤‡∏Å action=categories)
  selectedCategory   = String(cat.slug || '').trim();
  selectedCategoryTH = String(cat.th   || '').trim();
  selectedCategoryEN = String(cat.en   || '').trim();

  // ‡πÄ‡∏õ‡∏¥‡∏î popup ‡πÇ‡∏´‡∏•‡∏î
  showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢...');
         
         // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏´‡∏≤ "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢" ‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ (‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A)
  const subs = await loadSubCategories(selectedCategoryTH, { silent:true });
         
         // ‡∏õ‡∏¥‡∏î popup
  hideLoading();

      // ‡∏ñ‡πâ‡∏≤ slug ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡πÅ‡∏°‡∏õ‡πÄ‡∏î‡∏¥‡∏° (termination/accident/safety/complaint) ‚Üí ‡πÅ‡∏™‡∏î‡∏á sub
     if (subs && subs.length){
    // ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢ ‚Üí ‡πÑ‡∏õ Step 3
    document.getElementById('subCategoryTitle').textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢‡∏Ç‡∏≠‡∏á ‚Äú${selectedCategoryTH || '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'}‚Äù`;
    document.getElementById('categoryStep').classList.add('hidden');
    document.getElementById('subCategoryStep').classList.remove('hidden');
    document.getElementById('step2').classList.remove('active');
    document.getElementById('step2').classList.add('completed');
    document.getElementById('step3').classList.add('active');
    currentStep = 3;
  } else {
    // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢ ‚Üí ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
    selectedSubCategoryName = '';
    showEmployeeLogin();
      }
    }

    function showSubCategories(category){
      const container = document.getElementById('subCategoryCards');
      container.innerHTML = '';
      (subCategories[category]||[]).forEach(sub => {
        const card = document.createElement('button');
        card.type = 'button';
        card.className = 'card-hover bg-gradient-to-br from-white to-blue-50 rounded-2xl shadow-xl p-6 border border-blue-100 hover:border-blue-300 hover:shadow-2xl';
        card.innerHTML = `<div class="text-center"><div class="text-4xl mb-4">${sub.icon}</div><h3 class="text-lg font-bold text-gray-800 mb-2">${sub.name}</h3><p class="text-sm text-gray-600">${sub.desc}</p></div>`;
        card.onclick = () => selectSubCategory(sub.id);
        container.appendChild(card);
      });
    }
    async function selectSubCategory(name){
  selectedSubCategoryName = name;

  // ‡πÄ‡∏õ‡∏¥‡∏î popup ‡πÇ‡∏´‡∏•‡∏î
  showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...');
  const groups = await loadDetails(selectedCategoryTH, selectedSubCategoryName);
  hideLoading();

  // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Step 3 ‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ô subCategoryCards)
  renderDetailCards(groups);
}
    
    function selectDetail(name){
  selectedDetailName = name;
  showEmployeeLogin();
}

    // ===== Details step =====
   function proceedToDetails(){
  // ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î/‡∏¢‡πà‡∏≠‡∏¢/‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
  const catLabel = selectedCategoryTH || '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà';
  const subLabel = selectedSubCategoryName || '';
  const detLabel = selectedDetailName || '';

  // ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î (‡∏ñ‡πâ‡∏≤ slug ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á preset ‚Üí ‡πÉ‡∏ä‡πâ default)
  const icons = {
    termination:'bg-gradient-to-br from-red-400 to-red-600',
    accident:'bg-gradient-to-br from-orange-400 to-orange-600',
    safety:'bg-gradient-to-br from-yellow-400 to-yellow-600',
    complaint:'bg-gradient-to-br from-purple-400 to-purple-600',
    default:'bg-gradient-to-br from-blue-400 to-blue-600'
  };
  const iconBox = document.getElementById('priorityIcon');
  const colorClass = icons[selectedCategory] || icons.default;
  iconBox.className = `w-12 h-12 rounded-2xl mr-3 shadow-lg ${colorClass}`;

  // ‡∏ï‡∏±‡πâ‡∏á‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
  let title = `‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î${catLabel}`;
  if (subLabel) title += ` - ${subLabel}`;
  if (detLabel) title += ` - ${detLabel}`;

  document.getElementById('formTitle').textContent = title;
  document.getElementById('formSubtitle').textContent =
    detLabel
      ? `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ${detLabel} ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô`
      : (subLabel
          ? `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ${subLabel} ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô`
          : `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ${catLabel} ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô`);

  // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  const now = new Date();
  document.getElementById('reportDate').value =
    new Intl.DateTimeFormat('en-CA', { timeZone:'Asia/Bangkok' }).format(now);
  document.getElementById('reportTime').value =
    new Intl.DateTimeFormat('en-GB', { hour: '2-digit', minute: '2-digit', hour12:false, timeZone:'Asia/Bangkok' }).format(now);

  // ‡πÇ‡∏ä‡∏ß‡πå Step 4
  document.getElementById('subCategoryStep').classList.add('hidden');
  document.getElementById('categoryStep').classList.add('hidden');
  document.getElementById('detailsStep').classList.remove('hidden');

  document.getElementById('step2').classList.remove('active');
  document.getElementById('step2').classList.add('completed');
  document.getElementById('step3').classList.add('completed');
  document.getElementById('step4').classList.add('active');
  currentStep = 4;
}

    function goBackToCategory(){
      document.getElementById('subCategoryStep').classList.add('hidden');
      document.getElementById('categoryStep').classList.remove('hidden');
      document.getElementById('step3').classList.add('active');
    }

    function toggleDateEdit(){
      const el = document.getElementById('reportDate');
      const btn = document.getElementById('editDateBtn');
      el.readOnly = !el.readOnly;
      el.classList.toggle('cursor-not-allowed');
      el.classList.toggle('bg-yellow-50');
      btn.textContent = el.readOnly ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
    }
    function toggleTimeEdit(){
      const el = document.getElementById('reportTime');
      const btn = document.getElementById('editTimeBtn');
      el.readOnly = !el.readOnly;
      el.classList.toggle('cursor-not-allowed');
      el.classList.toggle('bg-yellow-50');
      btn.textContent = el.readOnly ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
    }

    async function nextStep(){
  const ids = ['introStep','categoryStep','subCategoryStep','detailsStep','successStep'];

  // ‡∏ã‡πà‡∏≠‡∏ô section ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô + ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô
  document.getElementById(ids[currentStep-1]).classList.add('hidden');
  if(currentStep <= 4){
    const step = document.getElementById(`step${currentStep}`);
    step.classList.remove('active');
    step.classList.add('completed');
  }
  currentStep++;

  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™tep 2 ‡∏Å‡πá‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
  if (currentStep !== 2){
    document.getElementById(ids[currentStep-1]).classList.remove('hidden');
    if(currentStep <= 4){ document.getElementById(`step${currentStep}`).classList.add('active'); }
    return;
  }

  // === ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™tep 2: ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏ö‡∏ö‡∏°‡∏µ popup ===
  document.getElementById(`step${currentStep}`).classList.add('active');

  // ‡∏¢‡∏±‡∏á "‡πÑ‡∏°‡πà" ‡πÄ‡∏õ‡∏¥‡∏î categoryStep ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏ä‡∏ß‡πå‡∏Å‡πà‡∏≠‡∏ô
  document.getElementById('categoryStep').classList.add('hidden');

  // ‡πÄ‡∏õ‡∏¥‡∏î popup ‡πÇ‡∏´‡∏•‡∏î
  showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á...');

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• + render ‡∏Å‡∏≤‡∏£‡πå‡∏î (‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞ loader ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤)
  await loadCategories({ silent:true });

  // ‡∏õ‡∏¥‡∏î popup ‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏ä‡∏ß‡πå section ‡∏û‡∏£‡πâ‡∏≠‡∏° effect ‡πÄ‡∏ú‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏∏‡∏î
  hideLoading();
  const section = document.getElementById('categoryStep');
  section.classList.remove('hidden');
  section.classList.add('opacity-0');
  requestAnimationFrame(()=>{
    section.classList.add('transition-opacity','duration-300');
    section.classList.remove('opacity-0');
  });
}

    function goBack(){
      if(currentStep === 4){
        document.getElementById('detailsStep').classList.add('hidden');
        document.getElementById('subCategoryStep').classList.remove('hidden');
        document.getElementById('step4').classList.remove('active');
        document.getElementById('step3').classList.remove('completed');
        document.getElementById('step3').classList.add('active');
        currentStep = 3;
        return;
      }
      const ids = ['introStep','categoryStep','subCategoryStep','detailsStep','successStep'];
      document.getElementById(ids[currentStep-1]).classList.add('hidden');
      if(currentStep <= 4){ document.getElementById(`step${currentStep}`).classList.remove('active'); }
      currentStep--;
      if(currentStep <= 4){
        const step = document.getElementById(`step${currentStep}`);
        step.classList.remove('completed');
        step.classList.add('active');
      }
      document.getElementById(ids[currentStep-1]).classList.remove('hidden');
    }

    function markAllStepsCompleted() {
  for (let i = 1; i <= 4; i++) {
    const el = document.getElementById('step' + i);
    if (!el) continue;
    el.classList.remove('active');
    el.classList.add('completed');
  }
}   
    
    async function submitReport(e){
  e.preventDefault();

  // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)
  const detailText = (document.getElementById('incidentDetail').value || '').trim();
  if(!detailText){
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå');
    return;
  }

  // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ô‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤
  const Location = (document.getElementById('locationInput').value || '').trim();
  const EmpName  = (document.getElementById('employeeName').value || '').trim();
  const EmpId    = (document.getElementById('employeeCode').value || '').trim();
  const Dept     = (document.getElementById('employeeDepartment').value || '').trim();
  const Phone    = (document.getElementById('employeePhone').value || '').trim();

  // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö‡πÑ‡∏´‡∏°
  if(!EmpId){
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô (‡∏Å‡∏£‡∏≠‡∏Å ‚Äú‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‚Äù)');
    return;
  }

  // ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏à‡∏≤‡∏Å Step ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
  const Category    = selectedCategoryTH || '';
  const SubCategory = selectedSubCategoryName || '';
  const Detail      = selectedDetailName ? `${selectedDetailName} ‚Äî ${detailText}` : detailText;

  // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
  const total = Array.from(document.getElementById('incidentPhotos').files || [])
    .reduce((s,f)=> s + f.size, 0);
  if (total > MAX_TOTAL_UPLOAD) {
    alert('‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏ß‡∏°‡πÄ‡∏Å‡∏¥‡∏ô 20MB ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå');
    return;
  }

  try{
    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Ñ‡∏™...');

    // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å input ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏õ‡∏•‡∏á base64
    const Images = await collectImagesFromInput(); // [{name,mimeType,base64}, ...]

    // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á payload ‡∏™‡πà‡∏á‡πÑ‡∏õ Apps Script
    const payload = {
      action: 'create',
      Category, SubCategory, Detail, Location,
      EmpId, EmpName, Dept, Phone,
      Images
    };

    // ‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const rs = await apiPost(payload);
    hideLoading();

    if(!rs.ok){
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (rs.error || 'unknown'));
      return;
    }

    // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏•‡∏Ç‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å server (Apps Script ‡∏Ñ‡∏ß‡∏£‡∏™‡πà‡∏á caseId ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤)
    document.getElementById('referenceNumber').textContent = rs.caseId || '‚Äî';
    
    // ‚úÖ ‡∏ó‡∏≥‡∏î‡∏ß‡∏á stepper ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ success
markAllStepsCompleted();
nextStep();   // ‡∏à‡∏≤‡∏Å step 4 ‚Üí ‡πÑ‡∏õ successStep

  }catch(err){
    hideLoading();
    alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n' + (err.message || err));
  }
}

    function resetForm(){
  currentStep = 1;
  selectedCategory = '';
  selectedCategoryTH = '';
  selectedCategoryEN = '';
  selectedSubCategory = '';
  selectedSubCategoryName = '';
  selectedDetailName = '';
      
      const ids = ['introStep','categoryStep','subCategoryStep','detailsStep','successStep'];
  ids.forEach((id, i)=>{
    const el = document.getElementById(id);
    if(i===0) el.classList.remove('hidden'); else el.classList.add('hidden');
    if(i < 4){ const st = document.getElementById(`step${i+1}`); st.classList.remove('active','completed'); }
  });
  document.getElementById('step1').classList.add('active');
  document.querySelectorAll('form').forEach(f=>f.reset());
  showPage('report');
}

    // ===== HRBP login & demo dashboard =====
    function showHRBPLogin(){ document.getElementById('hrbpModal').classList.remove('hidden'); }
    function closeHRBPModal(){ document.getElementById('hrbpModal').classList.add('hidden'); }
    function verifyHRBP(e){
      e.preventDefault();
      const id = document.getElementById('hrbpId').value.trim().toUpperCase();
      if(id==='HRBP001' || id==='ADMIN'){ isHRBPLoggedIn = true; closeHRBPModal(); alert('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö HRBP (‡πÄ‡∏î‡πÇ‡∏°)'); }
      else alert('‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô HRBP ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á\n\n‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö: ‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™ HRBP001');
    }

    function viewFactoryDetails(factoryId){ showHRBPLogin(); window.selectedFactory=factoryId; }

    // ===== History (demo) =====
    function verifyHistoryAccess(e){
      e.preventDefault();
      const id = document.getElementById('historyEmployeeId').value.trim();
      if(id==='1234'){
        isHistoryLoggedIn = true;
        document.getElementById('historyLoginSection').classList.add('hidden');
        document.getElementById('historyContent').classList.remove('hidden');
      } else alert('‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
    }
    function logoutHistory(){
      isHistoryLoggedIn = false;
      document.getElementById('historyLoginSection').classList.remove('hidden');
      document.getElementById('historyContent').classList.add('hidden');
      document.getElementById('historyEmployeeId').value = '';
      document.getElementById('searchResults').classList.add('hidden');
    }

    function searchByCase(){
      const caseId = document.getElementById('caseSearch').value.trim();
      if(!caseId){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏™'); return; }
      const mock = {
        'HR-2025-001': { id:'HR-2025-001', type:'‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡πâ‡∏≤‡∏á - ‡∏•‡∏≤‡∏≠‡∏≠‡∏Å', date:'19 ‡∏ï.‡∏Ñ. 2025', status:'‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', employee:'‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ (1234)', details:'‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏•‡∏¥‡∏ï‡∏Ç‡∏≠‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß' }
      };
      const result = mock[caseId.toUpperCase()];
      if(result) showSearchResults([result]); else alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏Ñ‡∏™‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤');
    }

    function showSearchResults(rows){
      const wrap = document.getElementById('resultsContainer');
      const box  = document.getElementById('searchResults');
      wrap.innerHTML = '';
      rows.forEach(r => {
        const statusColor = r.status==='‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? 'green' : 'yellow';
        const typeColor = r.type.includes('‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡πâ‡∏≤‡∏á') ? 'red' : r.type.includes('‡∏≠‡∏∏‡∏ö‡∏±‡∏ï‡∏¥‡πÄ‡∏´‡∏ï‡∏∏') ? 'orange' : r.type.includes('‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢') ? 'yellow' : 'purple';
        const card = document.createElement('div');
        card.className = `bg-gradient-to-r from-${typeColor}-50 to-${typeColor}-100 rounded-xl p-6 border-l-4 border-${typeColor}-500`;
        card.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <h4 class="text-lg font-bold text-gray-800 mb-2">${r.id} - ${r.type}</h4>
              <p class="text-gray-600 mb-2">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${r.employee} | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${r.date}</p>
              <p class="text-sm text-gray-500">${r.details}</p>
            </div>
            <div class="flex flex-col gap-2">
              <span class="px-3 py-1 bg-${statusColor}-100 text-${statusColor}-800 text-sm rounded-full">${r.status}</span>
              <button onclick="viewCaseHistory('${r.id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
              ${r.status!=='‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' ? `<button onclick=\"closeCaseByEmployee('${r.id}')\" class=\"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm\">‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™</button>` : ''}
            </div>
          </div>`;
        wrap.appendChild(card);
      });
      box.classList.remove('hidden');
    }

    function viewCaseHistory(id){ viewCase(id); }
    function closeCaseByEmployee(id){ if(confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏™ ${id} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)){ alert(`‡πÄ‡∏Ñ‡∏™ ${id} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏î‡πÇ‡∏°)`); } }

    function viewCase(id){
      const data = {
        'HR-2025-001': { title:'HR-2025-001 - ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡πâ‡∏≤‡∏á - ‡∏•‡∏≤‡∏≠‡∏≠‡∏Å', priority:'‡∏î‡πà‡∏ß‡∏ô', location:'‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á', date:'19 ‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏° 2025', time:'14:30', details:'‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏•‡∏¥‡∏ï‡∏Ç‡∏≠‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏á‡∏≤‡∏ô', reporter:'‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ', status:'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' }
      }[id];
      if(!data) return;
      document.getElementById('caseTitle').textContent = data.title;
      document.getElementById('caseContent').innerHTML = `
        <div class="grid md:grid-cols-2 gap-4">
          <div><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${data.status}</div>
          <div><strong>‡∏£‡∏∞‡∏î‡∏±‡∏ö:</strong> <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">${data.priority}</span></div>
          <div><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</strong> ${data.location}</div>
          <div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${data.date}</div>
          <div><strong>‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${data.time}</div>
          <div><strong>‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:</strong> ${data.reporter}</div>
        </div>
        <div class="mt-4"><strong>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</strong><p class="mt-2 p-4 bg-gray-50 rounded-lg">${data.details}</p></div>`;
      document.getElementById('caseModal').classList.remove('hidden');
    }
    function closeCaseModal(){ document.getElementById('caseModal').classList.add('hidden'); }

    /** ---------- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏: ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï + ‡πÅ‡∏Ñ‡∏ä --------- */
let _LOCATIONS = null; // ‡πÅ‡∏Ñ‡∏ä‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ
async function ensureLocations(){
  if (Array.isArray(_LOCATIONS)) return _LOCATIONS;
  try{
    const rs = await apiGet({ action:'locations' });
    _LOCATIONS = (rs.ok ? rs.rows : []) || [];
  }catch{ _LOCATIONS = []; }
  return _LOCATIONS;
}

let _locDebounce = 0;
async function typeaheadLocation(q){
  // ‡πÅ‡∏™‡∏î‡∏á dropdown ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏á‡πÉ‡∏à‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏´‡πá‡∏ô‡∏•‡∏¥‡∏™‡∏ï‡πå
  const dropdown = document.getElementById('locationDropdown');
  const input    = document.getElementById('locationInput');

  // debounce 150ms ‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö
  clearTimeout(_locDebounce);
  _locDebounce = setTimeout(async () => {
    if (!q) { dropdown.classList.add('hidden'); return; }

    const items = await ensureLocations();
    const list = items
      .filter(v => v.toLowerCase().includes(q.toLowerCase()))
      .slice(0, 50); // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á

    if (list.length === 0){ dropdown.classList.add('hidden'); return; }

    dropdown.innerHTML = '';
    list.forEach(loc => {
      const div = document.createElement('div');
      div.className = 'px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm border-b border-gray-100 last:border-b-0';
      div.textContent = loc;
      div.onclick = () => { input.value = loc; dropdown.classList.add('hidden'); };
      dropdown.appendChild(div);
    });
    dropdown.classList.remove('hidden');
  }, 150);
}

// ‡∏õ‡∏¥‡∏î dropdown ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å
document.addEventListener('click', (e)=>{
  const dropdown = document.getElementById('locationDropdown');
  const input = document.getElementById('locationInput');
  if(dropdown && !dropdown.contains(e.target) && e.target!==input){
    dropdown.classList.add('hidden');
  }
});

/** ---------- ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ: ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß + ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå ---------- */
const MAX_FILES = 10;
const MAX_SIZE  = 5 * 1024 * 1024; // 5MB/‡πÑ‡∏ü‡∏•‡πå
const MAX_TOTAL_UPLOAD = 20 * 1024 * 1024; // 20MB ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡πÑ‡∏ü‡∏•‡πå
const ACCEPTED_TYPES = ['image/png','image/jpeg','image/jpg','image/heic'];

document.addEventListener('change', (e) => {
  if (e.target && e.target.id === 'incidentPhotos') {
    const files = Array.from(e.target.files || []);
    const preview = document.getElementById('photoPreview');
    preview.innerHTML = '';

    // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏ü‡∏•‡πå
    if (files.length > MAX_FILES) {
      alert(`‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${MAX_FILES} ‡∏£‡∏π‡∏õ`);
      e.target.value = '';
      return;
    }

    // ‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏ß‡∏°
    const total = files.reduce((sum, f) => sum + f.size, 0);
    if (total > MAX_TOTAL_UPLOAD) {
      alert('‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏ß‡∏°‡πÄ‡∏Å‡∏¥‡∏ô 20MB ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô/‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå');
      e.target.value = '';
      return;
    }

    // ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß + ‡∏ï‡∏£‡∏ß‡∏à‡∏Ç‡∏ô‡∏≤‡∏î/‡∏ä‡∏ô‡∏¥‡∏î‡∏ó‡∏µ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå
    files.forEach(f => {
      // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ö‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô octet-stream ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Å‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á
      const ext = (f.name.split('.').pop() || '').toLowerCase();
      const mimeOk = /^image\//i.test(f.type) || ACCEPTED_TYPES.includes(f.type);
      const extOk  = ['png','jpg','jpeg','heic'].includes(ext);
      if (!mimeOk && !extOk) {
        alert(`‡πÑ‡∏ü‡∏•‡πå "${f.name}" ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö`);
        return;
      }
      if (f.size > MAX_SIZE) {
        alert(`‡πÑ‡∏ü‡∏•‡πå "${f.name}" ‡πÄ‡∏Å‡∏¥‡∏ô 5MB`);
        return;
      }

      const url = URL.createObjectURL(f);
      const fig = document.createElement('div');
      fig.className = 'aspect-square rounded-lg overflow-hidden border border-gray-200';
      fig.innerHTML = `<img src="${url}" alt="" class="w-full h-full object-cover" />`;
      preview.appendChild(fig);
    });
  }
});

function fileToBase64(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = () => {
      const s = String(reader.result || '');
      const m = s.match(/^data:(.+);base64,(.*)$/);
      if(!m) return reject(new Error('‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
      resolve({ name:file.name, mimeType:m[1], base64:m[2] });
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function collectImagesFromInput(){
  const input = document.getElementById('incidentPhotos');
  if(!input || !input.files || !input.files.length) return [];
  const files = Array.from(input.files).slice(0, MAX_FILES);
  const ok = files.filter(f => ACCEPTED_TYPES.includes(f.type) || f.type.startsWith('image/'));
  return Promise.all(ok.map(fileToBase64));
}
    // ===== Init =====
    showPage('report');
  </script>
  <!-- Loading Modal -->
<!-- Loading Modal (no blur, no dim, normal text) -->
<div id="loadingModal" class="fixed inset-0 z-[60] hidden">
  <div class="w-full h-full flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl px-6 py-5 flex items-center gap-3">
      <svg class="w-6 h-6 animate-spin" viewBox="0 0 24 24" fill="none" aria-label="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" d="M4 12a8 8 0 018-8" stroke="currentColor" stroke-width="4"></path>
      </svg>
      <span id="loadingText" class="text-gray-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á...</span>
    </div>
  </div>
</div>
  
</body>
</html>
